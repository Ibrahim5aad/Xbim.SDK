@page "/viewer"
@inject IModelsService ModelsService
@inject IProcessingService ProcessingService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Model Viewer</PageTitle>

@if (loading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading model...</p>
        </div>
    </div>
}
else if (error != null)
{
    <div class="alert alert-danger m-4">
        <h4>Error</h4>
        <p>@error</p>
        <a href="models" class="btn btn-outline-primary">Back to Models</a>
    </div>
}
else if (modelVersion != null)
{
    <div class="viewer-container" style="height: calc(100vh - 120px);">
        <div class="viewer-header p-2 bg-light border-bottom d-flex justify-content-between align-items-center">
            <div>
                <strong>@model?.Name</strong>
                <span class="text-muted ms-2">Version @modelVersion.VersionNumber</span>
                <span class="badge @GetStatusBadgeClass(modelVersion.Status) ms-2">@GetStatusText(modelVersion.Status)</span>
            </div>
            <div>
                <a href="models?projectId=@model?.ProjectId" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>
        <div class="viewer-content" style="height: calc(100% - 50px);">
            @if (modelVersion.Status == ProcessingStatus._2 && wexbimUrl != null)
            {
                <OctopusViewer @ref="viewer"
                               Id="mainViewer"
                               Width="100%"
                               Height="100%"
                               OnViewerInitialized="OnViewerInitialized"
                               OnModelLoaded="OnModelLoaded"
                               OnError="OnViewerError" />
            }
            else if (modelVersion.Status == ProcessingStatus._1 || modelVersion.Status == ProcessingStatus._0)
            {
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-3">Model is being processed. Please wait...</p>
                    </div>
                </div>
            }
            else if (modelVersion.Status == ProcessingStatus._3)
            {
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="alert alert-danger">
                        <h5>Processing Failed</h5>
                        <p>@modelVersion.ErrorMessage</p>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    public Guid? VersionId { get; set; }

    private OctopusViewer? viewer;
    private ModelDto? model;
    private ModelVersionDto? modelVersion;
    private string? wexbimUrl;
    private bool loading = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        ProcessingService.OnStatusChanged += OnProcessingStatusChanged;

        if (!VersionId.HasValue || VersionId.Value == Guid.Empty)
        {
            error = "No version ID provided.";
            loading = false;
            return;
        }

        try
        {
            // Load model version
            modelVersion = await ModelsService.GetVersionAsync(VersionId.Value);
            if (modelVersion == null)
            {
                error = "Model version not found.";
                loading = false;
                return;
            }

            // Load model
            if (modelVersion.ModelId.HasValue)
            {
                model = await ModelsService.GetAsync(modelVersion.ModelId.Value);
            }

            // If ready, get the WexBIM URL
            if (modelVersion.Status == ProcessingStatus._2)
            {
                await LoadWexBim();
            }
            else if (modelVersion.Status == ProcessingStatus._1 || modelVersion.Status == ProcessingStatus._0)
            {
                // Start watching for status changes
                ProcessingService.StartWatching(VersionId.Value);
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load model: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadWexBim()
    {
        if (!VersionId.HasValue) return;

        try
        {
            var response = await ModelsService.GetWexBimAsync(VersionId.Value);
            if (response?.Stream != null)
            {
                using var ms = new MemoryStream();
                await response.Stream.CopyToAsync(ms);
                var bytes = ms.ToArray();

                // Create blob URL for the viewer
                wexbimUrl = await JS.InvokeAsync<string>("createBlobUrl", bytes, "application/octet-stream");
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load WexBIM: {ex.Message}";
        }
    }

    private async void OnProcessingStatusChanged(ModelVersionStatusChangedEventArgs args)
    {
        if (args.VersionId != VersionId) return;

        modelVersion = await ModelsService.GetVersionAsync(args.VersionId);

        if (args.NewStatus == ProcessingStatus._2)
        {
            ProcessingService.StopWatching(args.VersionId);
            await LoadWexBim();
        }
        else if (args.NewStatus == ProcessingStatus._3)
        {
            ProcessingService.StopWatching(args.VersionId);
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnViewerInitialized(string viewerId)
    {
        if (viewer != null && wexbimUrl != null)
        {
            await viewer.LoadModelAsync(wexbimUrl, model?.Name ?? "Model");
        }
    }

    private async Task OnModelLoaded(bool success)
    {
        if (viewer != null && success)
        {
            await viewer.ZoomFitAsync();
        }
    }

    private void OnViewerError(Octopus.Blazor.Interop.ViewerEventArgs args)
    {
        error = $"Viewer error: {args.Message}";
        StateHasChanged();
    }

    private string GetStatusBadgeClass(ProcessingStatus? status) => status switch
    {
        ProcessingStatus._0 => "bg-secondary",
        ProcessingStatus._1 => "bg-primary",
        ProcessingStatus._2 => "bg-success",
        ProcessingStatus._3 => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusText(ProcessingStatus? status) => status switch
    {
        ProcessingStatus._0 => "Pending",
        ProcessingStatus._1 => "Processing",
        ProcessingStatus._2 => "Ready",
        ProcessingStatus._3 => "Failed",
        _ => "Unknown"
    };

    public void Dispose()
    {
        ProcessingService.OnStatusChanged -= OnProcessingStatusChanged;
        if (VersionId.HasValue)
        {
            ProcessingService.StopWatching(VersionId.Value);
        }
    }
}
