@page "/viewer"
@layout ViewerLayout
@using Octopus.Blazor.Components
@using Octopus.Blazor.Components.BuiltInButtons
@using Octopus.Blazor.Interop
@using Octopus.Blazor.Models
@inject IModelsService ModelsService
@inject IProcessingService ProcessingService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Model Viewer</PageTitle>

@if (loading)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading model...</p>
        </div>
    </div>
}
else if (error != null)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="alert alert-danger m-4">
            <h4>Error</h4>
            <p>@error</p>
            <a href="models" class="btn btn-outline-primary">Back to Models</a>
        </div>
    </div>
}
else if (modelVersion != null)
{
    <div class="viewer-container" style="height: 100vh; width: 100%; position: relative;">
        @if (modelVersion.Status == ProcessingStatus._2 && wexbimUrl != null)
        {
            <OctopusViewer @ref="viewer"
                           Id="mainViewer"
                           Width="100%"
                           Height="100%"
                           OnViewerInitialized="OnViewerInitialized"
                           OnModelLoaded="OnModelLoaded"
                           OnError="OnViewerError">

                @if (viewer != null)
                {
                    <ViewerToolbar Items="@_toolbarItems"
                                   Position="ToolbarPosition.Bottom"
                                   Alignment="ToolbarAlignment.Center" />
                }
            </OctopusViewer>

            <div class="viewer-header-overlay">
                <div class="model-info">
                    <strong>@model?.Name</strong>
                    <span class="text-muted ms-2">v@modelVersion.VersionNumber</span>
                </div>
                <a href="models?projectId=@model?.ProjectId" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        }
        else if (modelVersion.Status == ProcessingStatus._1 || modelVersion.Status == ProcessingStatus._0)
        {
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-3">Model is being processed. Please wait...</p>
                </div>
            </div>
        }
        else if (modelVersion.Status == ProcessingStatus._3)
        {
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="alert alert-danger">
                    <h5>Processing Failed</h5>
                    <p>@modelVersion.ErrorMessage</p>
                </div>
            </div>
        }
    </div>
}

@code {
    [SupplyParameterFromQuery]
    public Guid? VersionId { get; set; }

    private OctopusViewer? viewer;
    private ModelDto? model;
    private ModelVersionDto? modelVersion;
    private string? wexbimUrl;
    private bool loading = true;
    private string? error;

    // Toolbar and plugins
    private List<ToolbarItemBase> _toolbarItems = new();
    private SectionBoxPlugin? _sectionBoxPlugin;
    private ClippingPlanePlugin? _clippingPlanePlugin;
    private bool _interactivePluginsInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        ProcessingService.OnStatusChanged += OnProcessingStatusChanged;

        if (!VersionId.HasValue || VersionId.Value == Guid.Empty)
        {
            error = "No version ID provided.";
            loading = false;
            return;
        }

        try
        {
            // Load model version
            modelVersion = await ModelsService.GetVersionAsync(VersionId.Value);
            if (modelVersion == null)
            {
                error = "Model version not found.";
                loading = false;
                return;
            }

            // Load model
            if (modelVersion.ModelId.HasValue)
            {
                model = await ModelsService.GetAsync(modelVersion.ModelId.Value);
            }

            // If ready, get the WexBIM URL
            if (modelVersion.Status == ProcessingStatus._2)
            {
                await LoadWexBim();
            }
            else if (modelVersion.Status == ProcessingStatus._1 || modelVersion.Status == ProcessingStatus._0)
            {
                // Start watching for status changes
                ProcessingService.StartWatching(VersionId.Value);
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load model: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadWexBim()
    {
        if (!VersionId.HasValue) return;

        try
        {
            var response = await ModelsService.GetWexBimAsync(VersionId.Value);
            if (response?.Stream != null)
            {
                using var ms = new MemoryStream();
                await response.Stream.CopyToAsync(ms);
                var bytes = ms.ToArray();

                // Create blob URL for the viewer
                wexbimUrl = await JS.InvokeAsync<string>("createBlobUrl", bytes, "application/octet-stream");
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load WexBIM: {ex.Message}";
        }
    }

    private async void OnProcessingStatusChanged(ModelVersionStatusChangedEventArgs args)
    {
        if (args.VersionId != VersionId) return;

        modelVersion = await ModelsService.GetVersionAsync(args.VersionId);

        if (args.NewStatus == ProcessingStatus._2)
        {
            ProcessingService.StopWatching(args.VersionId);
            await LoadWexBim();
        }
        else if (args.NewStatus == ProcessingStatus._3)
        {
            ProcessingService.StopWatching(args.VersionId);
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnViewerInitialized(string viewerId)
    {
        InitializeToolbar();

        if (viewer != null && wexbimUrl != null)
        {
            await viewer.LoadModelAsync(wexbimUrl, model?.Name ?? "Model");
        }

        await InvokeAsync(StateHasChanged);
    }

    private void InitializeToolbar()
    {
        if (viewer == null) return;

        _toolbarItems = new List<ToolbarItemBase>
        {
            ViewerBuiltInButtons.CreatePerspectiveToggle(viewer, startWithPerspective: true),
            ViewerBuiltInButtons.CreateZoomFitButton(viewer),
            ViewerBuiltInButtons.CreateResetViewButton(viewer),
            ViewerBuiltInButtons.CreateViewsDropdown(viewer),
            ViewerBuiltInButtons.CreateNavigationButtons(viewer),
            ViewerBuiltInButtons.CreateXRayToggle(viewer),
            ViewerBuiltInButtons.CreateHideToggle(viewer),
            ViewerBuiltInButtons.CreateIsolateToggle(viewer),
            ViewerBuiltInButtons.CreateClearSelectionButton(viewer),
            ViewerBuiltInButtons.CreateSectionBoxButtons(viewer, () => _sectionBoxPlugin, "Box", StateHasChanged),
            ViewerBuiltInButtons.CreateClippingPlaneButtons(viewer, () => _clippingPlanePlugin, "Plane", StateHasChanged)
        };
    }

    private async Task OnModelLoaded(bool success)
    {
        if (viewer != null && success)
        {
            // Initialize interactive plugins after first model load (they need geometry)
            if (!_interactivePluginsInitialized)
            {
                _sectionBoxPlugin = new SectionBoxPlugin
                {
                    IsStopped = true
                };
                await viewer.AddPluginAsync(_sectionBoxPlugin);

                _clippingPlanePlugin = new ClippingPlanePlugin
                {
                    IsStopped = true
                };
                await viewer.AddPluginAsync(_clippingPlanePlugin);

                _interactivePluginsInitialized = true;
            }

            await viewer.ZoomFitAsync();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnViewerError(Octopus.Blazor.Interop.ViewerEventArgs args)
    {
        error = $"Viewer error: {args.Message}";
        StateHasChanged();
    }

    private string GetStatusBadgeClass(ProcessingStatus? status) => status switch
    {
        ProcessingStatus._0 => "bg-secondary",
        ProcessingStatus._1 => "bg-primary",
        ProcessingStatus._2 => "bg-success",
        ProcessingStatus._3 => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusText(ProcessingStatus? status) => status switch
    {
        ProcessingStatus._0 => "Pending",
        ProcessingStatus._1 => "Processing",
        ProcessingStatus._2 => "Ready",
        ProcessingStatus._3 => "Failed",
        _ => "Unknown"
    };

    public void Dispose()
    {
        ProcessingService.OnStatusChanged -= OnProcessingStatusChanged;
        if (VersionId.HasValue)
        {
            ProcessingService.StopWatching(VersionId.Value);
        }
    }
}
